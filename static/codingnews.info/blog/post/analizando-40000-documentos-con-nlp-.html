<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Coding News - Analizando 40.000 documentos con NLP</title>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />

    <meta name="author" content="Marcos Vanetta">
    <meta name="description" content="Blog about my experiences as a Knight Mozilla Fellow">
    <meta name="keywords" content="DDJ, Texas, open data, open source, ruby, python, JavaScript">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="/stylesheets/all.css">
    <style>
    .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight .cm {
  color: #999988;
  font-style: italic;
}
.highlight .cp {
  color: #999999;
  font-weight: bold;
}
.highlight .c1 {
  color: #999988;
  font-style: italic;
}
.highlight .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
.highlight .c, .highlight .cd {
  color: #999988;
  font-style: italic;
}
.highlight .err {
  color: #a61717;
  background-color: #e3d2d2;
}
.highlight .gd {
  color: #000000;
  background-color: #ffdddd;
}
.highlight .ge {
  color: #000000;
  font-style: italic;
}
.highlight .gr {
  color: #aa0000;
}
.highlight .gh {
  color: #999999;
}
.highlight .gi {
  color: #000000;
  background-color: #ddffdd;
}
.highlight .go {
  color: #888888;
}
.highlight .gp {
  color: #555555;
}
.highlight .gs {
  font-weight: bold;
}
.highlight .gu {
  color: #aaaaaa;
}
.highlight .gt {
  color: #aa0000;
}
.highlight .kc {
  color: #000000;
  font-weight: bold;
}
.highlight .kd {
  color: #000000;
  font-weight: bold;
}
.highlight .kn {
  color: #000000;
  font-weight: bold;
}
.highlight .kp {
  color: #000000;
  font-weight: bold;
}
.highlight .kr {
  color: #000000;
  font-weight: bold;
}
.highlight .kt {
  color: #445588;
  font-weight: bold;
}
.highlight .k, .highlight .kv {
  color: #000000;
  font-weight: bold;
}
.highlight .mf {
  color: #009999;
}
.highlight .mh {
  color: #009999;
}
.highlight .il {
  color: #009999;
}
.highlight .mi {
  color: #009999;
}
.highlight .mo {
  color: #009999;
}
.highlight .m, .highlight .mb, .highlight .mx {
  color: #009999;
}
.highlight .sb {
  color: #d14;
}
.highlight .sc {
  color: #d14;
}
.highlight .sd {
  color: #d14;
}
.highlight .s2 {
  color: #d14;
}
.highlight .se {
  color: #d14;
}
.highlight .sh {
  color: #d14;
}
.highlight .si {
  color: #d14;
}
.highlight .sx {
  color: #d14;
}
.highlight .sr {
  color: #009926;
}
.highlight .s1 {
  color: #d14;
}
.highlight .ss {
  color: #990073;
}
.highlight .s {
  color: #d14;
}
.highlight .na {
  color: #008080;
}
.highlight .bp {
  color: #999999;
}
.highlight .nb {
  color: #0086B3;
}
.highlight .nc {
  color: #445588;
  font-weight: bold;
}
.highlight .no {
  color: #008080;
}
.highlight .nd {
  color: #3c5d5d;
  font-weight: bold;
}
.highlight .ni {
  color: #800080;
}
.highlight .ne {
  color: #990000;
  font-weight: bold;
}
.highlight .nf {
  color: #990000;
  font-weight: bold;
}
.highlight .nl {
  color: #990000;
  font-weight: bold;
}
.highlight .nn {
  color: #555555;
}
.highlight .nt {
  color: #000080;
}
.highlight .vc {
  color: #008080;
}
.highlight .vg {
  color: #008080;
}
.highlight .vi {
  color: #008080;
}
.highlight .nv {
  color: #008080;
}
.highlight .ow {
  color: #000000;
  font-weight: bold;
}
.highlight .o {
  color: #000000;
  font-weight: bold;
}
.highlight .w {
  color: #bbbbbb;
}
.highlight {
  background-color: #f8f8f8;
}
    .highlight {
      background-color: #FFF;
    }
    </style>
    <link href='http://fonts.googleapis.com/css?family=Oxygen:400,300,700'rel='stylesheet' type='text/css'>
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
  </head>
  <body>
    <!--[if lt IE 7]>
        <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
    <header class="main">
      <div class="title">
        <a href="http://codingnews.info/"><h2>CODING<strong>NEWS</strong></h2></a>
      </div>
      <div class="links">
        <ul>
          <li><a href="/about.html">About</a></li>
          <li><a href="/talks.html">Talks</a></li>
          <li><a href="http://twitter.com/malev"><i class="fa fa-twitter"></i></a></li>
          <li><a href="http://github.com/malev"><i class="fa fa-github-alt"></i></a></li>
          <li><a href="http://ar.linkedin.com/in/marcosvanetta"><i class="fa fa-linkedin"></i></a></li>
        </ul>
      </div>
      <img src="/images/100_0855.JPG" id="main-image">
    </header>
    <div class="main-container">
        <header class="article">
          <h2>Analizando 40.000 documentos con NLP</h2>
          <span class="date">
            Jul  5
          </span>
        </header>
        <article class="post">
          <p>En un <a href="/post/analizando-el-boletin-oficial.html">post anterior</a> vimos como
scrapear y extraer el texto de 40.000 documentos de la sección primera del
boletín oficial argentino. En el de hoy, vamos a realizar un análisis de
<em>Natural Language Processing</em> (NLP) en cada uno de esos documentos extraídos.</p>

<h2>NLP</h2>

<p>De todos las estudios que se pueden hacer con NLP vamos a hacer <strong>Named Entity
Classification</strong>. Esto nos permitirá detectar verbos, sujetos, adjetivos,
pronombres y signos de puntuación. Al mismo tiempo, y gracias a la herramienta
que elegida, vamos a detectar personas, lugares geográficos,
organizaciones y fechas. Todo esto lo vamos a hacer con una herramienta
llamada <a href="http://nlp.lsi.upc.edu/freeling/node/1">freeling</a> que se desarrolla
en la Universitat Politècnica de Catalunya y cuenta con modelos para trabajar
en el idioma Español. Destaco este punto porque la mayoría de las herramientas
NLP trabajan casi exclusivamente en Inglés.</p>

<p>Empezamos instalando freeling con:</p>
<pre><code class="highlight plaintext">brew install freeling
</code></pre>

<p>o, en Ubuntu 14.04:</p>
<pre><code class="highlight shell">sudo apt-get update -yq
sudo apt-get install gdebi -yq
sudo apt-get install libboost-regex-dev libicu-dev zlib1g-dev <span class="se">\</span>
                     libboost-system-dev libboost-program-options-dev <span class="se">\</span>
                     libboost-thread-dev -yq

wget https://github.com/TALP-UPC/FreeLing/releases/download/4.0/freeling-4.0-trusty-amd64.deb
sudo gdebi -n freeling-4.0-trusty-amd64.deb
</code></pre>

<p>Para probarlo, necesitamos conocer la ubicación de los archivos de
configuración:</p>

<ul>
<li>En <strong>osx</strong>: <code>/usr/local/Cellar/freeling/4.0/share/freeling/config</code></li>
<li>En <strong>Ubuntu</strong>: <code>/usr/share/freeling/config/</code></li>
</ul>

<p>Luego podemos ejecutar:</p>
<pre><code class="highlight shell"><span class="gp">$ </span><span class="nb">export </span><span class="nv">FREELINGSHARE</span><span class="o">=</span>/usr/local/Cellar/freeling/4.0/share/freeling/
<span class="gp">$ </span><span class="nb">echo</span> <span class="s2">"Hola mundo"</span> | analyzer -f /usr/local/Cellar/freeling/4.0/share/freeling/config/es.cfg
Hola hola I 1
mundo mundo NCMS000 1
</code></pre>

<p>Y, como en este caso queremos el módulo <code>nec</code> de <strong>named entity classification</strong>,
tendremos que correr:</p>
<pre><code class="highlight plaintext">$ echo "Abuelas encontró al nieto número 114" | analyze -f \
/usr/local/Cellar/freeling/4.0/share/freeling/config/es.cfg --nec --output json
</code></pre>

<p>Nuestro output será:</p>
<pre><code class="highlight json"><span class="p">{</span><span class="w">
  </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"tokens"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"t1.1"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"form"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Abuelas"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"lemma"</span><span class="p">:</span><span class="w"> </span><span class="s2">"abuelas"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"tag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"NP00SP0"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"ctag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"NP"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"pos"</span><span class="p">:</span><span class="w"> </span><span class="s2">"noun"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"proper"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"neclass"</span><span class="p">:</span><span class="w"> </span><span class="s2">"person"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"nec"</span><span class="p">:</span><span class="w"> </span><span class="s2">"PER"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"t1.2"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"form"</span><span class="p">:</span><span class="w"> </span><span class="s2">"encontr\u00f3"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"lemma"</span><span class="p">:</span><span class="w"> </span><span class="s2">"encontrar"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"tag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"VMIS3S0"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"ctag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"VMI"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"pos"</span><span class="p">:</span><span class="w"> </span><span class="s2">"verb"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"main"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"mood"</span><span class="p">:</span><span class="w"> </span><span class="s2">"indicative"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"tense"</span><span class="p">:</span><span class="w"> </span><span class="s2">"past"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"person"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"num"</span><span class="p">:</span><span class="w"> </span><span class="s2">"singular"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"t1.3"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"form"</span><span class="p">:</span><span class="w"> </span><span class="s2">"a"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"lemma"</span><span class="p">:</span><span class="w"> </span><span class="s2">"a"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"tag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SP"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"ctag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SP"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"pos"</span><span class="p">:</span><span class="w"> </span><span class="s2">"adposition"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"preposition"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"t1.4"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"form"</span><span class="p">:</span><span class="w"> </span><span class="s2">"el"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"lemma"</span><span class="p">:</span><span class="w"> </span><span class="s2">"el"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"tag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DA0MS0"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"ctag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DA"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"pos"</span><span class="p">:</span><span class="w"> </span><span class="s2">"determiner"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"article"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"gen"</span><span class="p">:</span><span class="w"> </span><span class="s2">"masculine"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"num"</span><span class="p">:</span><span class="w"> </span><span class="s2">"singular"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"t1.5"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"form"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nieto"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"lemma"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nieto"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"tag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"NCMS000"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"ctag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"NC"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"pos"</span><span class="p">:</span><span class="w"> </span><span class="s2">"noun"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"common"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"gen"</span><span class="p">:</span><span class="w"> </span><span class="s2">"masculine"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"num"</span><span class="p">:</span><span class="w"> </span><span class="s2">"singular"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"t1.6"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"form"</span><span class="p">:</span><span class="w"> </span><span class="s2">"n\u00famero"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"lemma"</span><span class="p">:</span><span class="w"> </span><span class="s2">"n\u00famero"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"tag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"NCMS000"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"ctag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"NC"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"pos"</span><span class="p">:</span><span class="w"> </span><span class="s2">"noun"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"common"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"gen"</span><span class="p">:</span><span class="w"> </span><span class="s2">"masculine"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"num"</span><span class="p">:</span><span class="w"> </span><span class="s2">"singular"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"t1.7"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"form"</span><span class="p">:</span><span class="w"> </span><span class="s2">"114"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"lemma"</span><span class="p">:</span><span class="w"> </span><span class="s2">"114"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"tag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Z"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"ctag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Z"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"pos"</span><span class="p">:</span><span class="w"> </span><span class="s2">"number"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>En este caso el resultado está en formato JSON y tiene un error ya que
<strong>Abuelas</strong> es una organización y no una persona. Claramente el model necesita
un poco de entrenamiento en DDHH argentinos. El entrenamiento será un cuento
para otro día.</p>

<p>El código será escrito en python, y por ende necesitamos instalar un wrapper
para freeling llamado <a href="https://github.com/malev/pyfreeling">pyfreeling</a>.
Su uso es muy similar al uso de <code>analyze</code>, la herramienta de línea de comandos
que viene con freeling.</p>

<h2>Map reduce</h2>

<blockquote>
<p>Este paso es opcional</p>
</blockquote>

<p>El análisis <code>nec</code> consume mucha memoria, procesador y, por supuesto, mucho
tiempo. Una forma simple de acelerar el proceso es usar más de un
nodo o computadora. Aquí vamos a usar un <strong>map-reduce</strong> manual para dividir
el proceso en 2 nodos: uno en DigitalOcean con 32Gb de ram y 12 CPUs y
el otro, una laptop con 16Gb de ram y un procesador i7 de 3.1GHz.</p>

<p>El archivo con los 40.000 documentos pesa 325M y su estructura es la siguiente:</p>

<ul>
<li>Un JSON por línea.</li>
<li>Cada JSON es un documento con título, metadata y contenido en HTML.</li>
</ul>

<p>Cómo tenemos un JSON por línea, podemos dividir el archivo por número de líneas:</p>
<pre><code class="highlight plaintext">split -n 20000 output.dat
</code></pre>

<p>Dask nos permite paralelizar en multiples nodos,
pero no vamos a usar ese feature en este post. El propósito es usar 2 nodos,</p>

<p>Ese comando nos va a dar 2 archivos con 20.000 documentos para usar en cada
nodo.</p>

<h2>Empezando con dask</h2>

<p>Una vez copiado el archivo en cualquiera de los nodos, podemos leer su
contenido con <code>read_text</code> y generar un objeto <code>bag</code> de <strong>Dask</strong>. También
vamos a encadenar algunas funciones para parsear el JSON, extraer el texto
del html, eliminar documentos nulos, etc:</p>
<pre><code class="highlight python"><span class="kn">import</span> <span class="nn">ujson</span>
<span class="kn">import</span> <span class="nn">dask.bag</span> <span class="kn">as</span> <span class="nn">db</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>


<span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="n">blob</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">blob</span><span class="p">[</span><span class="s">'dataList'</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">remove_empty</span><span class="p">(</span><span class="n">data_list</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">data_list</span>


<span class="k">def</span> <span class="nf">valid_columns</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s">'detalleNorma'</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s">'detalleNorma'</span><span class="p">],</span>
        <span class="s">'idTramite'</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s">'idTramite'</span><span class="p">]</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">extract_text</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">'idTramite'</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s">'idTramite'</span><span class="p">],</span>
            <span class="s">'parsedText'</span><span class="p">:</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'detalleNorma'</span><span class="p">],</span> <span class="s">"html.parser"</span><span class="p">)</span><span class="o">.</span>\
                <span class="n">getText</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">remove_nones</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>


<span class="n">bag</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="s">"file_1.dat"</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="mi">100000000</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">bag</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">ujson</span><span class="o">.</span><span class="n">loads</span><span class="p">)</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">extract</span><span class="p">)</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">remove_empty</span><span class="p">)</span><span class="o">.</span>\
    <span class="nb">map</span><span class="p">(</span><span class="n">valid_columns</span><span class="p">)</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">extract_text</span><span class="p">)</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">remove_nones</span><span class="p">)</span>
</code></pre>

<p>Vamos a usar un <code>blocksize</code> de 100.000.000 que <strong>Dask</strong> organizará en
<a href="/images/dask_workers.png">4 workers similares</a>. Para generar esa
gráfica usamos: <code>from dask.dot import dot_graph; dot_graph(df.dask)</code>.</p>

<h2>Análisis de entidades</h2>

<p>Una vez que tenemos un bag de <strong>Dask</strong> con los datos y los workers listos
podemos llamar a freeling con:</p>
<pre><code class="highlight python"><span class="kn">from</span> <span class="nn">pyfreeling</span> <span class="kn">import</span> <span class="n">Analyzer</span>

<span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">analyzer</span> <span class="o">=</span> <span class="n">Analyzer</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="s">'/usr/share/freeling/config/es-ar.cfg'</span><span class="p">)</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">xml_root</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'parsedText'</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">),</span> <span class="s">'nec'</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">xml_root</span><span class="o">.</span><span class="nb">iter</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s">'token'</span><span class="p">:</span>
                <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">))</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'idTramite'</span><span class="p">])</span>
        <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s">'idTramite'</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s">'idTramite'</span><span class="p">],</span> <span class="s">'tokens'</span><span class="p">:</span> <span class="n">tokens</span><span class="p">}</span>
<span class="n">tokens</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">tokenize</span><span class="p">)</span>
</code></pre>

<p>Y luego bajamos todo a disco:</p>
<pre><code class="highlight plaintext">tokens.map(ujson.dumps).to_textfiles('{}.*.dat'.format(filename))
</code></pre>

<p>Esta tarea toma varias horas y como resultado obtendremos algunos archivos
llamados: file<em>1.dat.0.dat, file</em>1.dat.1.dat, etc. Y su contenido será similiar
a:</p>
<pre><code class="highlight json"><span class="p">{</span><span class="w">
  </span><span class="s2">"idTramite"</span><span class="p">:</span><span class="w"> </span><span class="s2">"100000"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"tokens"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"ctag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"NP"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"form"</span><span class="p">:</span><span class="w"> </span><span class="s2">"MINISTERIO_DE_TRABAJO"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"neclass"</span><span class="p">:</span><span class="w"> </span><span class="s2">"organization"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"pos"</span><span class="p">:</span><span class="w"> </span><span class="s2">"noun"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"nec"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ORG"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"lemma"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ministerio_de_trabajo"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"tag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"NP00O00"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"proper"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"t1.1"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"ctag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Fc"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"form"</span><span class="p">:</span><span class="w"> </span><span class="s2">","</span><span class="p">,</span><span class="w">
      </span><span class="s2">"pos"</span><span class="p">:</span><span class="w"> </span><span class="s2">"punctuation"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"lemma"</span><span class="p">:</span><span class="w"> </span><span class="s2">","</span><span class="p">,</span><span class="w">
      </span><span class="s2">"tag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Fc"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"comma"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"t1.2"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="err">...</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p><strong>Nota:</strong> La estructura con la que organizamos los tokens es muy ineficiente.
No se es tabular y por lo tanto debe ser convertida en un último paso. Este
último paso se podría haber omitido con una mejor estructura.</p>
<pre><code class="highlight python"><span class="kn">import</span> <span class="nn">ujson</span>
<span class="kn">from</span> <span class="nn">dask</span> <span class="kn">import</span> <span class="n">bag</span>

<span class="k">def</span> <span class="nf">tabulate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s">'tokens'</span><span class="p">]:</span>
        <span class="n">token</span><span class="p">[</span><span class="s">'idTramite'</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'idTramite'</span><span class="p">]</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tokens</span>

<span class="n">b</span> <span class="o">=</span> <span class="n">bag</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="s">'file_1.dat.*.dat'</span><span class="p">)</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">ujson</span><span class="o">.</span><span class="n">loads</span><span class="p">)</span><span class="o">.</span>\
    <span class="nb">map</span><span class="p">(</span><span class="n">tabulate</span><span class="p">)</span><span class="o">.</span><span class="n">concat</span><span class="p">()</span>
<span class="n">b</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">ujson</span><span class="o">.</span><span class="n">dumps</span><span class="p">)</span><span class="o">.</span><span class="n">to_textfiles</span><span class="p">(</span><span class="s">'tabulated.*.dat'</span><span class="p">)</span>
</code></pre>

<p>En próximos posts haremos análisis de los <strong>33.276.028</strong> datos obtenidos. Y si
te queres adelantar, los podes bajar <a href="https://s3-us-west-2.amazonaws.com/data.codingnews.info/boletin-nlp-freeling.tar.gz">aquí</a>.</p>

<p><strong>Nota:</strong> Publiqué un notebook con el código de ejemplo usado aquí.
Lamentablemente no se puede ejecutar pues Binder no tiene freeling instalado.
<a href="https://github.com/malev/codingnews.info/blob/master/notebooks/boletin_2.ipynb">Link al notebook</a>.</p>

        </article>
        <footer>
          <b>Tags:</b>
          <a href="/tags/python.html">python</a>, <a href="/tags/pydata.html">pydata</a>, <a href="/tags/nlp.html">nlp</a>, <a href="/tags/freeling.html">freeling</a>, <a href="/tags/dask.html">dask</a>
        </footer>
        <div class="comments">
          <div id="disqus_thread"></div>
          <script type="text/javascript">
          /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
          var disqus_shortname = 'codingnews'; // required: replace example with your forum shortname

          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>
    </div>
    <footer class="footer">
      <div class="resource">
        <label>Tags</label>
        <ul class="tags">
          <li><a href="/tags/scrapping.html">Scrapping (1)</a></li>
          <li><a href="/tags/dev.html">Dev (1)</a></li>
          <li><a href="/tags/random.html">Random (1)</a></li>
          <li><a href="/tags/programming.html">Programming (6)</a></li>
          <li><a href="/tags/analysis.html">Analysis (2)</a></li>
          <li><a href="/tags/python.html">Python (5)</a></li>
          <li><a href="/tags/opensource.html">Opensource (2)</a></li>
          <li><a href="/tags/ruby.html">Ruby (3)</a></li>
          <li><a href="/tags/hacking.html">Hacking (1)</a></li>
          <li><a href="/tags/conferences.html">Conferences (3)</a></li>
          <li><a href="/tags/community.html">Community (4)</a></li>
          <li><a href="/tags/open-hardware.html">Open Hardware (2)</a></li>
          <li><a href="/tags/opennews.html">Opennews (1)</a></li>
          <li><a href="/tags/community.html">Community (3)</a></li>
          <li><a href="/tags/piratebox.html">Piratebox (2)</a></li>
          <li><a href="/tags/open-internet.html">Open Internet (2)</a></li>
          <li><a href="/tags/share.html">Share (2)</a></li>
          <li><a href="/tags/hacking.html">Hacking (1)</a></li>
          <li><a href="/tags/databootcamp.html">Data Boot Camp (1)</a></li>
          <li><a href="/tags/workshop.html">Workshop (1)</a></li>
          <li><a href="/tags/javascript.html">Javascript (1)</a></li>
          <li><a href="/tags/opensource.html">Opensource (1)</a></li>
          <li><a href="/tags/open-data.html">Open Data (1)</a></li>
          <li><a href="/tags/pandas.html">Pandas (1)</a></li>
          <li><a href="/tags/dask.html">Dask (2)</a></li>
          <li><a href="/tags/boletin-oficial.html">Boletin Oficial (1)</a></li>
          <li><a href="/tags/argentina.html">Argentina (1)</a></li>
          <li><a href="/tags/data.html">Data (2)</a></li>
          <li><a href="/tags/datos.html">Datos (2)</a></li>
          <li><a href="/tags/pydata.html">Pydata (2)</a></li>
          <li><a href="/tags/nlp.html">Nlp (2)</a></li>
          <li><a href="/tags/freeling.html">Freeling (1)</a></li>
          <li><a href="/tags/nodejs.html">Nodejs (1)</a></li>
          <li><a href="/tags/data-science.html">Data Science (1)</a></li>
        </ul>
      </div>
      <div class="resource">
        <label>Resources</label>
        <ul class="links">
          <li><a href="/about.html">About</a></li>
          <li><a href="/about.html#projects">Projects</a></li>
          <li><a href="/talks.html">Talks</a></li>
          <li><a href="/feed.xml">Feed</a></li>
        </ul>
      </div>
    </footer>
    <script>
        (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
        function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
        e=o.createElement(i);r=o.getElementsByTagName(i)[0];
        e.src='//www.google-analytics.com/analytics.js';
        r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
        ga('create','UA-29516046-2');ga('send','pageview');
    </script>
    <script type="text/javascript">
      var images = ['berlin.png', 'brussels.png', 'rosario.png', 'austin.png'],
          element = document.getElementById('main-image'),
          img;
      img = images[Math.floor(Math.random() * images.length)];

      element.setAttribute('src', '/images/' + img);
    </script>
  </body>
</html>
